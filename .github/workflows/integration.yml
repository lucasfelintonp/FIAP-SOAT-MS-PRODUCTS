name: Integration

on:
    pull_request:
        types: [opened, synchronize, reopened, edited, ready_for_review]
    push:
        branches: [ main, develop ]

jobs:
    build:
        name: Build, Test and Static Analysis
        runs-on: ubuntu-latest
        strategy:
            matrix:
                java: [17]
        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Dependency review (SCA quick check)
              uses: actions/dependency-review-action@v4

            - name: Run Dependabot (informational)
              run: echo "Dependabot is configured via .github/dependabot.yml and runs on schedule; use Dependabot PRs to update deps"

            - name: Set up JDK
              uses: actions/setup-java@v5
              with:
                  distribution: temurin
                  java-version: ${{ matrix.java }}
                  cache: maven

            - name: Cache Maven repository
              uses: actions/cache@v5
              with:
                  path: ~/.m2/repository
                  key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}

            - name: Build and run tests
              run: mvn -B -DskipTests=false verify

            - name: Run Checkstyle
              run: mvn checkstyle:check || true

            - name: Run SpotBugs
              run: mvn com.github.spotbugs:spotbugs-maven-plugin:4.7.4.0:check || true

            - name: Generate code coverage (JaCoCo)
              run: mvn jacoco:report

            - name: Enforce minimum coverage (80%)
              run: |
                  xml=target/site/jacoco/jacoco.xml
                  if [ ! -f "$xml" ]; then echo "Jacoco report not found: $xml"; exit 1; fi
                  vals=$(grep '<counter type="INSTRUCTION"' "$xml" | sed -E 's/.*missed="([0-9]+)".*covered="([0-9]+)".*/\1 \2/')
                  missed=$(echo $vals | awk '{print $1}')
                  covered=$(echo $vals | awk '{print $2}')
                  total=$((missed+covered))
                  if [ $total -eq 0 ]; then echo "No instructions found in JaCoCo report"; exit 1; fi
                  # compute percentage with integer arithmetic
                  percent=$((100 * covered / total))
                  echo "Coverage: ${percent}% (covered=${covered} total=${total})"
                  if [ $percent -lt 80 ]; then echo "Coverage ${percent}% is less than required 80%"; exit 1; fi

            - name: SonarQube analysis (optional)
              if: ${{ secrets.SONAR_TOKEN != '' && secrets.SONAR_HOST_URL != '' && secrets.SONAR_PROJECT_KEY != '' }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
                  SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
                  SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
              run: |
                  mvn -B org.sonarsource.scanner.maven:sonar-maven-plugin:sonar -Dsonar.host.url=${SONAR_HOST_URL} -Dsonar.login=${SONAR_TOKEN} || true
                  # Wait for quality gate (polling)
                  echo "Waiting for SonarQube Quality Gate..."
                  for i in 1 2 3 4 5; do
                    sleep 5
                    status=$(curl -s -u ${SONAR_TOKEN}: ${SONAR_HOST_URL}/api/qualitygates/project_status?projectKey=${SONAR_PROJECT_KEY} | jq -r '.projectStatus.status') || true
                    echo "SonarQube project status: $status"
                    if [ "$status" = "OK" ]; then
                      echo "Quality Gate passed"
                      break
                    fi
                    if [ "$status" = "ERROR" ] || [ "$status" = "WARN" ]; then
                      echo "Quality Gate failed: $status"
                      exit 1
                    fi
                  done

            - name: OWASP Dependency Check (optional)
              run: mvn org.owasp:dependency-check-maven:check || true

    deploy:
        name: Build & Deploy to EKS
        runs-on: ubuntu-latest
        needs: build
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'

        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Configure AWS credentials
                uses: aws-actions/configure-aws-credentials@v4
                with:
                    aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                    aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                    aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
                    aws-region: ${{ env.AWS_REGION }}

            -   name: Login to Amazon ECR
                uses: aws-actions/amazon-ecr-login@v2

            -   name: Build, tag and push image
                run: |
                    IMAGE_TAG=${GITHUB_SHA}
                    ECR_URI=${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${AWS_REGION}.amazonaws.com

                    docker build -t ${ECR_REPOSITORY}:${IMAGE_TAG} .
                    docker tag ${ECR_REPOSITORY}:${IMAGE_TAG} ${ECR_URI}/${ECR_REPOSITORY}:latest
                    docker tag ${ECR_REPOSITORY}:${IMAGE_TAG} ${ECR_URI}/${ECR_REPOSITORY}:${IMAGE_TAG}

                    docker push ${ECR_URI}/${ECR_REPOSITORY}:latest
                    docker push ${ECR_URI}/${ECR_REPOSITORY}:${IMAGE_TAG}

            -   name: Update kubeconfig
                run: |
                    aws eks update-kubeconfig \
                      --region ${AWS_REGION} \
                      --name ${EKS_CLUSTER_NAME}

            -   name: Deploy to Kubernetes
                env:
                    SPRING_DATASOURCE_USERNAME: ${{ secrets.SPRING_DATASOURCE_USERNAME }}
                    SPRING_DATASOURCE_PASSWORD: ${{ secrets.SPRING_DATASOURCE_PASSWORD }}
                    SPRING_DATASOURCE_URL: ${{ secrets.SPRING_DATASOURCE_URL }}
                    MONGODB_URL: ${{ secrets.MONGODB_URL }}
                run: |
                    kubectl apply -f k8s/aws/namespace.yaml

                    kubectl create secret generic catalog-secret \
                        --namespace fastfood \
                        --from-literal=SPRING_DATASOURCE_USERNAME="$SPRING_DATASOURCE_USERNAME" \
                        --from-literal=SPRING_DATASOURCE_PASSWORD="$SPRING_DATASOURCE_PASSWORD" \
                        --from-literal=SPRING_DATASOURCE_URL="$SPRING_DATASOURCE_URL" \
                        --dry-run=client -o yaml | kubectl apply -f -

                    kubectl apply -f k8s/aws/catalog-deployment.yaml
                    kubectl apply -f k8s/aws/catalog-service.yaml

            -   name: Force Rollout
                run: |
                    kubectl rollout restart deployment catalog -n fastfood
